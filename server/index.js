require('dotenv').config();
const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const OpenAI = require('openai');
const axios = require('axios');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(bodyParser.json());
app.use(express.static('public'));

// OpenAI Configuration
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ะกะธััะตะผะฝัะน ะฟัะพะผะฟั ะดะปั ะฝะตะนัะพะฟัะพะดะฐะฒัะฐ
const SALES_SYSTEM_PROMPT = `ะขั - ะฝะตะนัะพะฟัะพะดะฐะฒะตั ะบะพะผะฟะฐะฝะธะธ ${process.env.COMPANY_NAME || 'lidorubov.net'}, ะธัะฟะพะปัะทัััะธะน ะฟะตัะตะดะพะฒัะต ัะตัะฝะพะปะพะณะธะธ GPT-5. ะขะฒะพั ะทะฐะดะฐัะฐ - ะฒััะฒะธัั ะฟะพััะตะฑะฝะพััะธ ะบะปะธะตะฝัะฐ ะธ ะฟัะพะดะฐัั ััะปัะณั ะฟะพ ะฟะตัะตะดะฐัะต ะณะพะปะพัะพะผ ะฟะพะดัะฒะตัะถะดะตะฝะฝัั ะบะปะธะตะฝัะพะฒ. ะขั ะดะพะปะถะตะฝ ัััะพะณะพ ัะปะตะดะพะฒะฐัั ัะบัะธะฟัั ะฟัะพะดะฐะถ, ะบะพัะพััะน ะฒะบะปััะฐะตั:

1. ะะะะะะขะกะขะะะ: ะัะตะดััะฐะฒััั ะธ ะบัะฐัะบะพ ะพะฟะธัะธ ัััั ััะปัะณะธ
   "ะะฐั ะฟัะธะฒะตัััะฒัะตั ะฝะตะนัะพะฟัะพะดะฐะฒะตั ะบะพะผะฟะฐะฝะธะธ lidorubov.net. ะั ะฟะตัะตะดะฐะตะผ ะฒะฐะผ ัะพะปัะบะพ ัะตั ะบะปะธะตะฝัะพะฒ, ะบะพัะพััะต ะณะพะปะพัะพะผ ะฟะพะดัะฒะตัะดะธะปะธ, ััะพ ัะพััั ั ะฒะฐั ะบัะฟะธัั. ะญัะพ ะฝะต ัะตะบะปะฐะผะฐ, ะฐ ะณะพัะพะฒัะต ะฟัะพะดะฐะถะธ. ะฃ ะฒะฐั ะตััั 2 ะผะธะฝััั?"

2. ะะะขะะะะขะะข: ะะฐััะบะฐะถะธ ะฟัะพ ััะฟะตัะฝัะต ะบะตะนัั
   "ะั ัะฐะฑะพัะฐะตะผ ั ะบััะฟะฝัะผะธ ะบะพะผะฟะฐะฝะธัะผะธ: ะัะบัััะธะต ะะฐะฝะบ, BMW, Skillbox, ะกะฑะตัะฑะฐะฝะบ ะธ ะดััะณะธะผะธ. ะะพะปะตะต 7 ะปะตั ะฒ ะฝะธัะต, ั ะบะตะนัะฐะผะธ ัะพััะฐ ะฟัะพะดะฐะถ ะฝะฐ 30-50% ะทะฐ 2-3 ะผะตัััะฐ."

3. ะะะะะะะกะขะะะ: ะะฐะดะฐะน 5 ะบะปััะตะฒัั ะฒะพะฟัะพัะพะฒ ะดะปั ะฒััะฒะปะตะฝะธั ะฟะพััะตะฑะฝะพััะตะน:
   - "ะะฐะบะพะน ั ะฒะฐั ัะตะบััะธะน ััะตะดะฝะธะน ัะตะบ?"
   - "ะะฐะบะธะผ ะพะฑัะฐะทะพะผ ะฒั ะฟัะธะฒะปะตะบะฐะตัะต ะบะปะธะตะฝัะพะฒ? (ัะตะบะปะฐะผะฐ, ัะตะบะพะผะตะฝะดะฐัะธะธ, ัะพะปะดะบะพะปั ะธ ั.ะด.)"
   - "ะฃ ะฒะฐั ะตััั ัะฐะนั? ะัะปะธ ะดะฐ, ะฟะพะดะตะปะธัะตัั URL."
   - "ะั ะธัะฟะพะปัะทัะตัะต ะฏะฝะดะตะบั ะะธัะตะบั ะธะปะธ ะดััะณะธะต ัะตะบะปะฐะผะฝัะต ะบะฐะฝะฐะปั?"
   - "ะฃ ะฒะฐั ะตััั ะพัะดะตะป ะฟัะพะดะฐะถ? ะัะปะธ ะดะฐ, ะทะฐะฝะธะผะฐัััั ะปะธ ะพะฝะธ ัะพะปะพะดะฝัะผะธ ะทะฒะพะฝะบะฐะผะธ?"

4. ะะะะะะะขะะฆะะฏ: ะะฑัััะฝะธ ะฟัะตะธะผััะตััะฒะฐ ะฝะฐัะตะน ััะปัะณะธ
   "ะะฐัะธ ะฐะปะณะพัะธัะผั ะฝะฐัะพะดัั ะปัะดะตะน, ะบะพัะพััะต ะฟััะผะพ ัะตะนัะฐั ะธััั ะฒะฐัะธ ััะปัะณะธ, ัะธะปััััะตะผ ะธั ะฟะพ ะบัะธัะตัะธัะผ, ะฟะพะดัะฒะตัะถะดะฐัั ะธะฝัะตัะตั ะณะพะปะพัะพะผ, ะธ ะฟะตัะตะดะฐัะผ ะฒะฐะผ ัะถะต ะณะพัะพะฒัั ะบ ะฟะพะบัะฟะบะต ะบะปะธะตะฝัะพะฒ."

5. ZOOM/ะะะะขะะะข: ะัะตะดะปะพะถะธ ะฒัััะตัั ะธะปะธ ะฟะพะฟัะพัะธ ะบะพะฝัะฐะบั
   "ะัะตะดะปะฐะณะฐั ะทะฐ 20 ะผะธะฝัั ะฒ Zoom ะฟะพะบะฐะทะฐัั ะบะพะฝะบัะตัะฝัะต ัะธััั ะธ ะบะตะนัั ะฟะพ ะฒะฐัะตะน ะฝะธัะต. ะะพะณะดะฐ ะฒะฐะผ ัะดะพะฑะฝะตะต โ ะทะฐะฒััะฐ ะฒ 10:00 ะธะปะธ ะฒ 14:00? ะะปะธ ะพััะฐะฒััะต ัะตะปะตัะพะฝ, ะธ ะผั ั ะฒะฐะผะธ ัะฒัะถะตะผัั."

6. ะะะะะะะะะะฏ: ะัะปะธ ะพัะบะฐะท - ะฝะฐััะพะนัะธะฒะพ ะฟัะตะดะปะพะถะธ Zoom ะธะปะธ ะฒะพะทัะผะธ ัะตะปะตัะพะฝ
   "ะะพะฝะธะผะฐั, ััะพ ะฒั ัะฝะฐัะฐะปะฐ ัะพัะธัะต ะฒัั ะพะฑะดัะผะฐัั. ะะพ ัะตัะตะฝะธะต ะทะดะตัั ะฟัะพััะพะต: ะปะธะฑะพ ะฒั ะฒะธะดะธัะต, ะบะฐะบ ััะพ ัะฐะฑะพัะฐะตั ะฒ ะฒะฐัะตะน ะฝะธัะต, ะปะธะฑะพ ะฝะตั. 20 ะผะธะฝัั ะฒ Zoom โ ะธ ะฒั ัะฐะผะธ ัะตัะธัะต. ะะพะณะดะฐ ััะฐะฒะธะผ ะฒัััะตัั?"

ะัะพะฑะตะฝะฝะพััะธ ะฟะพะฒะตะดะตะฝะธั:
- ะัะดั ะฝะฐััะพะนัะธะฒัะผ, ะฝะพ ะฒะตะถะปะธะฒัะผ
- ะัะฟะพะปัะทัะน ะฟะพะปััะตะฝะฝัั ะธะฝัะพัะผะฐัะธั ะดะปั ะฟะตััะพะฝะฐะปะธะทะฐัะธะธ ะพัะฒะตัะพะฒ
- ะะฐะฟะพะผะธะฝะฐะน ะพัะฒะตัั ะบะปะธะตะฝัะฐ ะธ ะธัะฟะพะปัะทัะน ะธั ะฒ ะดะฐะปัะฝะตะนัะตะผ ัะฐะทะณะพะฒะพัะต
- ะัะปะธ ะบะปะธะตะฝั ะดะฐะป ะบะปััะตะฒัั ะธะฝัะพัะผะฐัะธั (ัะตะปะตัะพะฝ, email, ัะพะณะปะฐัะธะต ะฝะฐ ะฒัััะตัั) - ััะฐะทั ะฟะตัะตะฐะดัะตััะน ะบ ัะปะตะดัััะตะผั ััะฐะฟั
- ะะพะฒะพัะธ ะบะพัะพัะบะพ ะธ ะฟะพ ะดะตะปั
- ะัะฟะพะปัะทัะน ะดะฐะฝะฝัะต ะธะท ัะฐะทะณะพะฒะพัะฐ ะดะปั ััะธะปะตะฝะธั ัะฑะตะดะธัะตะปัะฝะพััะธ

ะะต ะพัะบะปะพะฝัะนัั ะพั ัะบัะธะฟัะฐ. ะะตัะตัะพะดะธ ะบ ัะปะตะดัััะตะผั ััะฐะฟั ัะพะปัะบะพ ะฟะพัะปะต ะฟะพะปััะตะฝะธั ะพัะฒะตัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐ ัะตะบััะธะน ะฒะพะฟัะพั, ะตัะปะธ ััะพ ัะผะตััะฝะพ.`;

// ะฅัะฐะฝะธะปะธัะต ะดะธะฐะปะพะณะพะฒ (ะฒ ัะตะฐะปัะฝะพะผ ะฟัะพะตะบัะต ะธัะฟะพะปัะทะพะฒะฐัั ะะ)
const conversations = new Map();

// ะะฟัะตะดะตะปะตะฝะธะต ััะฐะฟะฐ ะปะธะดะฐ
function detectLeadStage(userMessage, conversationHistory) {
  const message = userMessage.toLowerCase();
  
  const triggers = {
    'zoom': 'ะกะพะณะปะฐัะธะต ะฝะฐ ะฒัััะตัั',
    'ะฒัััะตัะฐ': 'ะกะพะณะปะฐัะธะต ะฝะฐ ะฒัััะตัั',
    'ัะตะปะตัะพะฝ': 'ะััะฐะฒะธะป ะบะพะฝัะฐะบัั',
    'ะฟะพะทะฒะพะฝะธัะต': 'ะะฐะฟัะพั ะทะฒะพะฝะบะฐ',
    'ะทะฒะพะฝะธัะต': 'ะะฐะฟัะพั ะทะฒะพะฝะบะฐ',
    'email': 'ะััะฐะฒะธะป ะบะพะฝัะฐะบัั',
    'ะฟะพััะฐ': 'ะััะฐะฒะธะป ะบะพะฝัะฐะบัั',
    'ะฟะพะดัะผะฐัั': 'ะะพะทัะฐะถะตะฝะธะต - ะฟะพะดัะผะฐัั',
    'ะฝะตั ะฒัะตะผะตะฝะธ': 'ะะพะทัะฐะถะตะฝะธะต - ะฝะตั ะฒัะตะผะตะฝะธ',
    'ะฝะต ะธะฝัะตัะตััะตั': 'ะะพะทัะฐะถะตะฝะธะต - ะฝะต ะธะฝัะตัะตััะตั',
    'ะฝะต ะฝัะถะฝะพ': 'ะะพะทัะฐะถะตะฝะธะต - ะฝะต ะธะฝัะตัะตััะตั',
    'ัะถะต ะตััั': 'ะะพะทัะฐะถะตะฝะธะต - ัะถะต ะตััั ัะตัะตะฝะธะต',
    'ะธะฝัะตัะตััะตั': 'ะัะพัะฒะธะป ะธะฝัะตัะตั',
    'ะณะพัะพะฒ ะพะฑััะดะธัั': 'ะัะพัะฒะธะป ะธะฝัะตัะตั',
    'ะดะฐ': conversationHistory.length > 2 ? 'ะะพะปะพะถะธัะตะปัะฝัะน ะพัะฒะตั' : null,
    'ะพะบ': conversationHistory.length > 2 ? 'ะะพะปะพะถะธัะตะปัะฝัะน ะพัะฒะตั' : null,
    'ะปะฐะดะฝะพ': conversationHistory.length > 2 ? 'ะะพะปะพะถะธัะตะปัะฝัะน ะพัะฒะตั' : null,
    'ัะพะณะปะฐัะตะฝ': 'ะกะพะณะปะฐัะธะต ะฝะฐ ะฒัััะตัั',
    'ะดะฐะฒะฐะนัะต': 'ะกะพะณะปะฐัะธะต ะฝะฐ ะฒัััะตัั',
    'ะทะฐะฟะธัะธัะต': 'ะกะพะณะปะฐัะธะต ะฝะฐ ะฒัััะตัั',
    'ะผะฝะต ะฟะพะดัะพะดะธั': 'ะกะพะณะปะฐัะธะต ะฝะฐ ะฒัััะตัั',
    'ััะตะดะฝะธะน ัะตะบ': 'ะะธะฐะณะฝะพััะธะบะฐ - ััะตะดะฝะธะน ัะตะบ ัะฟะพะผัะฝัั',
    'ัะตะบะปะฐะผะฐ': 'ะะธะฐะณะฝะพััะธะบะฐ - ะบะฐะฝะฐะป ะฟัะธะฒะปะตัะตะฝะธั',
    'ัะฐะนั': 'ะะธะฐะณะฝะพััะธะบะฐ - ัะฟะพะผะธะฝะฐะฝะธะต ัะฐะนัะฐ',
    'ะดะธัะตะบั': 'ะะธะฐะณะฝะพััะธะบะฐ - ัะฟะพะผะธะฝะฐะฝะธะต ัะตะบะปะฐะผั',
    'ะพัะดะตะป ะฟัะพะดะฐะถ': 'ะะธะฐะณะฝะพััะธะบะฐ - ัะฟะพะผะธะฝะฐะฝะธะต ะพัะดะตะปะฐ ะฟัะพะดะฐะถ',
    'ัะพะปะพะดะฝัะต ะทะฒะพะฝะบะธ': 'ะะธะฐะณะฝะพััะธะบะฐ - ัะฟะพะผะธะฝะฐะฝะธะต ัะพะปะพะดะฝัั ะทะฒะพะฝะบะพะฒ',
  };
  
  for (const [keyword, stage] of Object.entries(triggers)) {
    if (message.includes(keyword) && stage) {
      return stage;
    }
  }
  
  return null;
}

// ะะทะฒะปะตัะตะฝะธะต ะบะพะฝัะฐะบัะพะฒ ะธะท ัะพะพะฑัะตะฝะธั
function extractContacts(message) {
  const phoneRegex = /\+?[0-9]{1,4}?[-.\s]?\(?[0-9]{1,4}?\)?[-.\s]?[0-9]{1,4}[-.\s]?[0-9]{1,9}/g;
  const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
  const urlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/g;
  
  const phones = message.match(phoneRegex) || [];
  const emails = message.match(emailRegex) || [];
  const urls = message.match(urlRegex) || [];
  
  return {
    phones,
    emails,
    urls,
    hasContacts: phones.length > 0 || emails.length > 0 || urls.length > 0
  };
}

// ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธั ะฒ Telegram
async function sendTelegramNotification(leadData) {
  if (!process.env.TELEGRAM_BOT_TOKEN || !process.env.TELEGRAM_CHAT_ID) {
    console.log('Telegram ะฝะต ะฝะฐัััะพะตะฝ. ะะธะด:', leadData);
    return;
  }
  
  // ะะพะดะดะตัะถะบะฐ ะฝะตัะบะพะปัะบะธั chat_id ัะตัะตะท ะทะฐะฟัััั
  const chatIds = process.env.TELEGRAM_CHAT_ID.split(',').map(id => id.trim()).filter(id => id);
  
  const { stage, contacts, userMessage, conversationHistory } = leadData;
  
  const lastMessages = conversationHistory
    .slice(-5) // ะฃะฒะตะปะธัะธะผ ะดะพ 5 ะฟะพัะปะตะดะฝะธั ัะพะพะฑัะตะฝะธะน ะดะปั ะปัััะตะณะพ ะบะพะฝัะตะบััะฐ
    .map(msg => `${msg.role === 'user' ? '๐ค ะะปะธะตะฝั' : '๐ค ะะตะนัะพะฟัะพะดะฐะฒะตั'}: ${msg.content}`)
    .join('\n');
  
  let contactsInfo = 'ะะพะฝัะฐะบัั ะฝะต ัะบะฐะทะฐะฝั';
  if (contacts.hasContacts) {
    if (contacts.phones.length > 0) contactsInfo = `๐ ะขะตะปะตัะพะฝ: ${contacts.phones.join(', ')}\n`;
    if (contacts.emails.length > 0) contactsInfo += `๐ง Email: ${contacts.emails.join(', ')}\n`;
    if (contacts.urls.length > 0) contactsInfo += `๐ ะกะฐะนั: ${contacts.urls.join(', ')}\n`;
    contactsInfo = contactsInfo.trim();
  }
  
  // ะะฝะฐะปะธะทะธััะตะผ ัะฐะทะณะพะฒะพั, ััะพะฑั ะธะทะฒะปะตัั ะธะฝัะพัะผะฐัะธั ะพ ะฟะพััะตะฑะฝะพัััั ะบะปะธะตะฝัะฐ
  const conversationText = conversationHistory.map(msg => msg.content).join(' ');
  const needsInfo = analyzeClientNeeds(conversationText);
  
  let needsInfoText = '';
  if (needsInfo.length > 0) {
    needsInfoText = `\n๐ ะััะฒะปะตะฝะฝัะต ะฟะพััะตะฑะฝะพััะธ:\n${needsInfo.map(need => `โข ${need}`).join('\n')}\n`;
  }
  
  const message = `๐ฏ ะะะะซะ ะะะ | ${process.env.COMPANY_NAME || 'lidorubov.net'}
โโโโโโโโโโโโโโ
โฐ ะัะตะผั: ${new Date().toLocaleString('ru-RU')}
๐ ะญัะฐะฟ: ${stage}
${contactsInfo}
${needsInfoText}
๐ฌ ะะพัะปะตะดะฝะตะต ัะพะพะฑัะตะฝะธะต: "${userMessage}"
๐ ะััะพัะธั ัะฐะทะณะพะฒะพัะฐ (ะฟะพัะปะตะดะฝะธะต 5 ัะพะพะฑัะตะฝะธะน):
${lastMessages}`;
  
  // ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธั ะฒัะตะผ ะฐะดะผะธะฝะธัััะฐัะพัะฐะผ
  const sendPromises = chatIds.map(chatId => 
    axios.post(
      `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,
      {
        chat_id: chatId,
        text: message,
        parse_mode: 'HTML'
      }
    ).catch(error => {
      console.error(`โ ะัะธะฑะบะฐ ะพัะฟัะฐะฒะบะธ ะฒ Telegram (chat_id: ${chatId}):`, error.message);
      return null;
    })
  );
  
  try {
    const results = await Promise.allSettled(sendPromises);
    const successCount = results.filter(r => r.status === 'fulfilled' && r.value !== null).length;
    console.log(`โ ะฃะฒะตะดะพะผะปะตะฝะธะต ะพัะฟัะฐะฒะปะตะฝะพ ${successCount} ะธะท ${chatIds.length} ะฐะดะผะธะฝะธัััะฐัะพัะฐะผ`);
  } catch (error) {
    console.error('โ ะัะธัะธัะตัะบะฐั ะพัะธะฑะบะฐ ะพัะฟัะฐะฒะบะธ ะฒ Telegram:', error.message);
  }
}

// ะคัะฝะบัะธั ะดะปั ะฐะฝะฐะปะธะทะฐ ะฟะพััะตะฑะฝะพััะตะน ะบะปะธะตะฝัะฐ ะฟะพ ะธััะพัะธะธ ัะฐะทะณะพะฒะพัะฐ
function analyzeClientNeeds(conversationText) {
  const lowerText = conversationText.toLowerCase();
  const needs = [];
  
  // ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ััะตะดะฝะตะผ ัะตะบะต
  const avgCheckMatch = lowerText.match(/ััะตะดะฝะธะน ัะตะบ[:\s]*([0-9\s.,]+)/i);
  if (avgCheckMatch) {
    needs.push(`ะกัะตะดะฝะธะน ัะตะบ: ${avgCheckMatch[1].trim()}`);
  }
  
  // ะัะพะฒะตััะตะผ ะบะฐะฝะฐะปั ะฟัะธะฒะปะตัะตะฝะธั ะบะปะธะตะฝัะพะฒ
  if (lowerText.includes('ัะตะบะปะฐะผะฐ') || lowerText.includes('ัะตะบะปะฐะผั')) {
    needs.push('ะัะธะฒะปะตะบะฐะตั ะบะปะธะตะฝัะพะฒ ัะตัะตะท ัะตะบะปะฐะผั');
  }
  if (lowerText.includes('ัะตะบะพะผะตะฝะดะฐัะธะธ') || lowerText.includes('ะฟะพ ัะตะบะพะผะตะฝะดะฐัะธัะผ')) {
    needs.push('ะัะธะฒะปะตะบะฐะตั ะบะปะธะตะฝัะพะฒ ะฟะพ ัะตะบะพะผะตะฝะดะฐัะธัะผ');
  }
  if (lowerText.includes('ัะพะปะพะดะฝัะต') && lowerText.includes('ะทะฒะพะฝะบ')) {
    needs.push('ะัะฟะพะปัะทัะตั ัะพะปะพะดะฝัะต ะทะฒะพะฝะบะธ');
  }
  
  // ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ัะฐะนัะฐ
  if (lowerText.includes('ัะฐะนั') && !lowerText.includes('ะฝะตั ัะฐะนัะฐ') && !lowerText.includes('ัะฐะนัะฐ ะฝะตั')) {
    needs.push('ะััั ัะฐะนั');
  } else if (lowerText.includes('ะฝะตั ัะฐะนัะฐ') || lowerText.includes('ัะฐะนัะฐ ะฝะตั')) {
    needs.push('ะะตั ัะฐะนัะฐ');
  }
  
  // ะัะพะฒะตััะตะผ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ัะตะบะปะฐะผะฝัั ะบะฐะฝะฐะปะพะฒ
  if (lowerText.includes('ัะฝะดะตะบั') && lowerText.includes('ะดะธัะตะบั')) {
    needs.push('ะัะฟะพะปัะทัะตั ะฏะฝะดะตะบั ะะธัะตะบั');
  }
  if (lowerText.includes('google') && (lowerText.includes('ads') || lowerText.includes('adwords'))) {
    needs.push('ะัะฟะพะปัะทัะตั Google Ads');
  }
  
  // ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะพัะดะตะปะฐ ะฟัะพะดะฐะถ
  if (lowerText.includes('ะพัะดะตะป ะฟัะพะดะฐะถ') || lowerText.includes('ะตััั ะพัะดะตะป')) {
    needs.push('ะััั ะพัะดะตะป ะฟัะพะดะฐะถ');
  }
  
  // ะัะปะธ ะฝะต ะฝะฐัะปะธ ะบะพะฝะบัะตัะฝะพะน ะธะฝัะพัะผะฐัะธะธ, ัะบะฐะทัะฒะฐะตะผ ะพะฑัะธะต ะฟัะธะทะฝะฐะบะธ
  if (needs.length === 0) {
    if (lowerText.includes('ััะตะดะฝะธะน') && lowerText.includes('ัะตะบ')) needs.push('ะฃะฟะพะผะธะฝะฐะป ััะตะดะฝะธะน ัะตะบ');
    if (lowerText.includes('ะบะปะธะตะฝั') && (lowerText.includes('ะฟัะธะฒะปะตะบะฐ') || lowerText.includes('ะฝะฐัะพะถั'))) needs.push('ะะฑััะถะดะฐะป ะฟัะธะฒะปะตัะตะฝะธะต ะบะปะธะตะฝัะพะฒ');
    if (lowerText.includes('ัะฐะนั')) needs.push('ะะฑััะถะดะฐะป ะฝะฐะปะธัะธะต ัะฐะนัะฐ');
    if (lowerText.includes('ัะตะบะปะฐะผ')) needs.push('ะะฑััะถะดะฐะป ัะตะบะปะฐะผะฝัะต ะบะฐะฝะฐะปั');
    if (lowerText.includes('ะดะธัะตะบั')) needs.push('ะฃะฟะพะผะธะฝะฐะป ะฏะฝะดะตะบั ะะธัะตะบั');
    if (lowerText.includes('ะพัะดะตะป') && lowerText.includes('ะฟัะพะดะฐะถ')) needs.push('ะะฑััะถะดะฐะป ะพัะดะตะป ะฟัะพะดะฐะถ');
  }
  
  return needs;
}

// API Endpoint ะดะปั ัะฐัะฐ
app.post('/api/chat', async (req, res) => {
  try {
    const { message, sessionId } = req.body;
    
    if (!message || !sessionId) {
      return res.status(400).json({ error: 'ะขัะตะฑััััั message ะธ sessionId' });
    }
    
    // ะะพะปััะฐะตะผ ะธะปะธ ัะพะทะดะฐะตะผ ะธััะพัะธั ะดะธะฐะปะพะณะฐ
    if (!conversations.has(sessionId)) {
      conversations.set(sessionId, [
        { role: 'system', content: SALES_SYSTEM_PROMPT }
      ]);
    }
    
    const conversationHistory = conversations.get(sessionId);
    conversationHistory.push({ role: 'user', content: message });
    
    // ะัะทะพะฒ OpenAI API (ะฟัะตะดะฟะพะปะฐะณะฐะตะผ, ััะพ GPT-5 ะฑัะดะตั ะดะพัััะฟะตะฝ ะบะฐะบ 'gpt-5' ะธะปะธ 'gpt-5-turbo')
    const completion = await openai.chat.completions.create({
      model: process.env.OPENAI_MODEL || 'gpt-5', // ะะทะผะตะฝะตะฝะพ ะฝะฐ GPT-5
      messages: conversationHistory,
      temperature: parseFloat(process.env.OPENAI_TEMPERATURE) || 0.3,
      max_tokens: 800, // ะฃะฒะตะปะธัะธะฒะฐะตะผ ะปะธะผะธั ะดะปั ะฑะพะปะตะต ัะปะพะถะฝะพะน ะผะพะดะตะปะธ
    });
    
    const aiResponse = completion.choices[0].message.content;
    conversationHistory.push({ role: 'assistant', content: aiResponse });
    
    // ะะฟัะตะดะตะปัะตะผ, ัะฒะปัะตััั ะปะธ ััะพ ะปะธะดะพะผ
    const leadStage = detectLeadStage(message, conversationHistory);
    const contacts = extractContacts(message);
    
    if (leadStage || contacts.hasContacts) {
      // ะัะฟัะฐะฒะปัะตะผ ัะฒะตะดะพะผะปะตะฝะธะต ะฒ Telegram
      await sendTelegramNotification({
        stage: leadStage || 'ะััะฐะฒะธะป ะบะพะฝัะฐะบัั',
        contacts,
        userMessage: message,
        conversationHistory: conversationHistory.filter(msg => msg.role !== 'system')
      });
    }
    
    res.json({
      response: aiResponse,
      isLead: !!leadStage || contacts.hasContacts,
      leadStage
    });
    
  } catch (error) {
    console.error('ะัะธะฑะบะฐ ะฒ /api/chat:', error);
    res.status(500).json({ 
      error: 'ะัะธะฑะบะฐ ัะตัะฒะตัะฐ',
      message: error.message 
    });
  }
});

// Healthcheck endpoint
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'ok',
    version: process.env.SALES_SCRIPT_VERSION || '1.0',
    timestamp: new Date().toISOString()
  });
});

// ะะฐะฟััะบ ัะตัะฒะตัะฐ
app.listen(PORT, () => {
  console.log(`๐ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั ${PORT}`);
  console.log(`๐ ะะตััะธั ัะบัะธะฟัะฐ: ${process.env.SALES_SCRIPT_VERSION || '1.0'}`);
  console.log(`๐ค ะะพะดะตะปั OpenAI: ${process.env.OPENAI_MODEL || 'gpt-4'}`);
});
